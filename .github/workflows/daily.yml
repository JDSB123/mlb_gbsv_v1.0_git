name: Daily Pipeline

on:
  schedule:
    # Run at 10:00 UTC (6:00 AM ET) every day during MLB season (Mar-Oct)
    - cron: "0 10 * 3-10 *"
  workflow_dispatch:
    inputs:
      settle:
        description: "Settle yesterday's predictions"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      loader:
        description: "Data loader to use"
        required: false
        default: "odds_api"
        type: choice
        options:
          - odds_api
          - bets_api
          - synthetic

env:
  RESOURCE_GROUP: mlb-gbsv-v1-az-rg

jobs:
  daily-pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Fetch secrets from Key Vault
        run: |
          echo "ODDS_API_KEY=$(az keyvault secret show --vault-name mlb-gbsv-v1-az-kv --name odds-api-key --query value -o tsv)" >> $GITHUB_ENV
          echo "BETS_API_KEY=$(az keyvault secret show --vault-name mlb-gbsv-v1-az-kv --name bets-api-key --query value -o tsv)" >> $GITHUB_ENV
          echo "VISUAL_CROSSING_API_KEY=$(az keyvault secret show --vault-name mlb-gbsv-v1-az-kv --name visual-crossing-api-key --query value -o tsv)" >> $GITHUB_ENV
          echo "ACTION_NETWORK_PASSWORD=$(az keyvault secret show --vault-name mlb-gbsv-v1-az-kv --name action-network-password --query value -o tsv)" >> $GITHUB_ENV

      - name: Fetch Discord webhook (if set)
        continue-on-error: true
        run: |
          WEBHOOK=$(az keyvault secret show --vault-name mlb-gbsv-v1-az-kv --name discord-webhook-url --query value -o tsv 2>/dev/null || echo "")
          echo "DISCORD_WEBHOOK_URL=$WEBHOOK" >> $GITHUB_ENV

      - name: Run daily pipeline
        env:
          ODDS_API_KEY: ${{ env.ODDS_API_KEY }}
          BETS_API_KEY: ${{ env.BETS_API_KEY }}
          VISUAL_CROSSING_API_KEY: ${{ env.VISUAL_CROSSING_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ env.DISCORD_WEBHOOK_URL }}
        run: |
          SETTLE_FLAG=""
          if [ "${{ github.event.inputs.settle || 'true' }}" = "true" ]; then
            SETTLE_FLAG="--settle"
          fi
          LOADER="${{ github.event.inputs.loader || 'odds_api' }}"
          python scripts/daily_run.py --loader "$LOADER" $SETTLE_FLAG

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-artifacts-${{ github.run_number }}
          path: |
            artifacts/models/*.pkl
            artifacts/tracking.db
          retention-days: 30

      - name: Upload tracking DB to Azure Storage
        continue-on-error: true
        run: |
          STORAGE_KEY=$(az storage account keys list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --account-name mlbgbsvv1azsto \
            --query '[0].value' -o tsv)
          az storage container create \
            --name artifacts \
            --account-name mlbgbsvv1azsto \
            --account-key "$STORAGE_KEY" \
            --public-access off 2>/dev/null || true
          az storage blob upload \
            --container-name artifacts \
            --name tracking.db \
            --file artifacts/tracking.db \
            --account-name mlbgbsvv1azsto \
            --account-key "$STORAGE_KEY" \
            --overwrite
